---
# Fleet Authentication Secrets Management

# Per-GitRepo authentication secrets
- name: "Create GitRepo-specific authentication secrets (token or SSH)"
  kubernetes.core.k8s:
      kubeconfig: "{{ fleet_kubeconfig_path | default('/etc/rancher/k3s/k3s.yaml') }}"
      definition:
          apiVersion: v1
          kind: Secret
          metadata:
              name: "{{ item.name }}-git-auth"
              namespace: "{{ item.namespace | default(fleet_defaults.namespace) }}"
              labels:
                  "app.kubernetes.io/managed-by": "ansible"
                  "fleet.cattle.io/client-secret": "true"
                  "gitops.infrastructure/gitrepo": "{{ item.name }}"
          stringData: "{{ {'username': item.git_username, 'password': item.git_token} if item.git_token is defined and item.git_username is defined else {'ssh-privatekey': item.git_ssh_private_key, 'known_hosts': item.git_known_hosts} if item.git_ssh_private_key is defined and item.git_known_hosts is defined else {'ssh-privatekey': item.git_ssh_private_key} if item.git_ssh_private_key is defined else {} }}"
          type: "{{ 'kubernetes.io/basic-auth' if item.git_token is defined and item.git_username is defined else 'kubernetes.io/ssh-auth' if item.git_ssh_private_key is defined else '' }}"
      state: present
  loop: "{{ fleet_gitrepos | default([]) }}"
  when:
      - fleet_gitrepos | length > 0
      - (item.git_token is defined and item.git_username is defined) or (item.git_ssh_private_key is defined)
  tags:
      - fleet
      - fleet-secrets
      - fleet-gitrepo-secrets
