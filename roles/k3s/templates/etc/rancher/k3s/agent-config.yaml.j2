{#- K3s Agent Configuration Template with Best Practices -#}
{#- Generated by arillso.container.k3s role -#}
{#- Based on K3s official documentation and best practices -#}

{%- set k3s_agent_config = {} -%}

{#- === SERVER CONNECTION (Critical for Agent) === -#}
{#- Auto-discovery logic for server URL when not explicitly configured -#}
{%- if k3s_server_url is defined and k3s_server_url -%}
{%-   set _ = k3s_agent_config.update({'server': k3s_server_url}) -%}
{%- elif ansible_local.k3s.cluster_info.server_url is defined and ansible_local.k3s.cluster_info.server_url -%}
{%-   set _ = k3s_agent_config.update({'server': ansible_local.k3s.cluster_info.server_url}) -%}
{%- elif groups['k3s_controllers'] is defined and groups['k3s_controllers'] | length > 0 -%}
{%-   set server_host = groups['k3s_controllers'][0] -%}
{%-   set server_ip = hostvars[server_host]['ansible_default_ipv4']['address'] | default(server_host) -%}
{%-   set _ = k3s_agent_config.update({'server': 'https://' + server_ip + ':' + (k3s_https_listen_port | default(6443) | string)}) -%}
{%- elif groups['k3s_servers'] is defined and groups['k3s_servers'] | length > 0 -%}
{%-   set server_host = groups['k3s_servers'][0] -%}
{%-   set server_ip = hostvars[server_host]['ansible_default_ipv4']['address'] | default(server_host) -%}
{%-   set _ = k3s_agent_config.update({'server': 'https://' + server_ip + ':' + (k3s_https_listen_port | default(6443) | string)}) -%}
{%- else -%}
{#- Fallback: If no inventory groups are available, this will be handled by facts collection -#}
{%- endif -%}

{#- Token Authentication (Security Critical) -#}
{#- Auto-discovery logic for token when not explicitly configured -#}
{%- if k3s_token is defined and k3s_token -%}
{%-   set _ = k3s_agent_config.update({'token': k3s_token}) -%}
{%- elif ansible_local.k3s.cluster.token_exists | default(false) -%}
{#- Token will be retrieved automatically by the main tasks during execution -#}
{%- endif -%}

{#- === NODE CONFIGURATION === -#}
{%- if k3s_node_name is defined and k3s_node_name -%}
{%-   set _ = k3s_agent_config.update({'node-name': k3s_node_name}) -%}
{%- endif -%}

{%- if k3s_with_node_id is defined and k3s_with_node_id -%}
{%-   set _ = k3s_agent_config.update({'with-node-id': true}) -%}
{%- endif -%}

{%- if k3s_node_ip is defined and k3s_node_ip -%}
{%-   set _ = k3s_agent_config.update({'node-ip': k3s_node_ip}) -%}
{%- endif -%}

{%- if k3s_node_external_ip is defined and k3s_node_external_ip -%}
{%-   set _ = k3s_agent_config.update({'node-external-ip': k3s_node_external_ip}) -%}
{%- endif -%}

{#- DNS Configuration -#}
{%- if k3s_node_internal_dns is defined and k3s_node_internal_dns -%}
{%-   set _ = k3s_agent_config.update({'node-internal-dns': k3s_node_internal_dns}) -%}
{%- endif -%}

{%- if k3s_node_external_dns is defined and k3s_node_external_dns -%}
{%-   set _ = k3s_agent_config.update({'node-external-dns': k3s_node_external_dns}) -%}
{%- endif -%}

{#- Node Labels for Scheduling Control -#}
{%- if k3s_node_labels is defined and k3s_node_labels | length > 0 -%}
{%-   set _ = k3s_agent_config.update({'node-label': k3s_node_labels}) -%}
{%- endif -%}

{#- Node Taints for Workload Isolation -#}
{%- if k3s_node_taints is defined and k3s_node_taints | length > 0 -%}
{%-   set _ = k3s_agent_config.update({'node-taint': k3s_node_taints}) -%}
{%- endif -%}

{#- Image Credential Provider Configuration -#}
{%- if k3s_image_credential_provider_bin_dir is defined and k3s_image_credential_provider_bin_dir -%}
{%-   set _ = k3s_agent_config.update({'image-credential-provider-bin-dir': k3s_image_credential_provider_bin_dir}) -%}
{%- endif -%}

{%- if k3s_image_credential_provider_config is defined and k3s_image_credential_provider_config -%}
{%-   set _ = k3s_agent_config.update({'image-credential-provider-config': k3s_image_credential_provider_config}) -%}
{%- endif -%}

{#- === DATA STORAGE === -#}
{%- if k3s_data_dir is defined and k3s_data_dir -%}
{%-   set _ = k3s_agent_config.update({'data-dir': k3s_data_dir}) -%}
{%- endif -%}

{#- === CONTAINER RUNTIME CONFIGURATION === -#}
{%- if k3s_container_runtime_endpoint is defined and k3s_container_runtime_endpoint -%}
{%-   set _ = k3s_agent_config.update({'container-runtime-endpoint': k3s_container_runtime_endpoint}) -%}
{%- endif -%}

{%- if k3s_default_runtime is defined and k3s_default_runtime -%}
{%-   set _ = k3s_agent_config.update({'default-runtime': k3s_default_runtime}) -%}
{%- endif -%}

{%- if k3s_image_service_endpoint is defined and k3s_image_service_endpoint -%}
{%-   set _ = k3s_agent_config.update({'image-service-endpoint': k3s_image_service_endpoint}) -%}
{%- endif -%}

{#- Container Runtime Images and Storage -#}
{%- if k3s_pause_image is defined and k3s_pause_image -%}
{%-   set _ = k3s_agent_config.update({'pause-image': k3s_pause_image}) -%}
{%- endif -%}

{%- if k3s_snapshotter is defined and k3s_snapshotter -%}
{%-   set _ = k3s_agent_config.update({'snapshotter': k3s_snapshotter}) -%}
{%- endif -%}

{#- Registry Configuration -#}
{%- if k3s_private_registry is defined and k3s_private_registry -%}
{%-   set _ = k3s_agent_config.update({'private-registry': k3s_private_registry}) -%}
{%- endif -%}

{%- if k3s_disable_default_registry_endpoint is defined and k3s_disable_default_registry_endpoint -%}
{%-   set _ = k3s_agent_config.update({'disable-default-registry-endpoint': true}) -%}
{%- endif -%}

{%- if k3s_nonroot_devices is defined and k3s_nonroot_devices -%}
{%-   set _ = k3s_agent_config.update({'nonroot-devices': true}) -%}
{%- endif -%}

{#- Alternative Container Runtime -#}
{%- if k3s_docker is defined and k3s_docker -%}
{%-   set _ = k3s_agent_config.update({'docker': true}) -%}
{%- endif -%}

{#- === NETWORKING CONFIGURATION === -#}
{%- if k3s_bind_address is defined and k3s_bind_address -%}
{%-   set _ = k3s_agent_config.update({'bind-address': k3s_bind_address}) -%}
{%- endif -%}

{%- if k3s_resolv_conf is defined and k3s_resolv_conf -%}
{%-   set _ = k3s_agent_config.update({'resolv-conf': k3s_resolv_conf}) -%}
{%- endif -%}

{#- Flannel Network Interface Configuration -#}
{%- if k3s_flannel_iface is defined and k3s_flannel_iface -%}
{%-   set _ = k3s_agent_config.update({'flannel-iface': k3s_flannel_iface}) -%}
{%- endif -%}

{%- if k3s_flannel_conf is defined and k3s_flannel_conf -%}
{%-   set _ = k3s_agent_config.update({'flannel-conf': k3s_flannel_conf}) -%}
{%- endif -%}

{%- if k3s_flannel_cni_conf is defined and k3s_flannel_cni_conf -%}
{%-   set _ = k3s_agent_config.update({'flannel-cni-conf': k3s_flannel_cni_conf}) -%}
{%- endif -%}

{#- VPN Integration (Experimental) -#}
{%- if k3s_vpn_auth_file is defined and k3s_vpn_auth_file -%}
{%-   set _ = k3s_agent_config.update({'vpn-auth-file': k3s_vpn_auth_file}) -%}
{%- elif k3s_vpn_auth is defined and k3s_vpn_auth -%}
{%-   set _ = k3s_agent_config.update({'vpn-auth': k3s_vpn_auth}) -%}
{%- endif -%}

{#- Load Balancer Configuration -#}
{%- if k3s_lb_server_port is defined and k3s_lb_server_port -%}
{%-   set _ = k3s_agent_config.update({'lb-server-port': k3s_lb_server_port}) -%}
{%- endif -%}

{%- if k3s_disable_apiserver_lb is defined and k3s_disable_apiserver_lb -%}
{%-   set _ = k3s_agent_config.update({'disable-apiserver-lb': true}) -%}
{%- endif -%}

{#- === SECURITY CONFIGURATION === -#}
{%- if k3s_protect_kernel_defaults is defined and k3s_protect_kernel_defaults -%}
{%-   set _ = k3s_agent_config.update({'protect-kernel-defaults': true}) -%}
{%- endif -%}

{%- if k3s_selinux is defined and k3s_selinux -%}
{%-   set _ = k3s_agent_config.update({'selinux': true}) -%}
{%- endif -%}

{#- === LOGGING CONFIGURATION === -#}
{%- if k3s_log_file is defined and k3s_log_file -%}
{%-   set _ = k3s_agent_config.update({'log': k3s_log_file}) -%}
{%- endif -%}

{%- if k3s_debug is defined -%}
{%-   set _ = k3s_agent_config.update({'debug': k3s_debug}) -%}
{%- endif -%}

{%- if k3s_log_verbosity is defined and k3s_log_verbosity -%}
{%-   set _ = k3s_agent_config.update({'v': k3s_log_verbosity}) -%}
{%- endif -%}

{%- if k3s_vmodule is defined and k3s_vmodule -%}
{%-   set _ = k3s_agent_config.update({'vmodule': k3s_vmodule}) -%}
{%- endif -%}

{%- if k3s_alsologtostderr is defined -%}
{%-   set _ = k3s_agent_config.update({'alsologtostderr': k3s_alsologtostderr}) -%}
{%- endif -%}

{#- === PERFORMANCE TUNING === -#}
{%- set kubelet_args_list = [] -%}
{%- if k3s_kubelet_args is defined and k3s_kubelet_args | length > 0 -%}
{%-   set kubelet_args_list = kubelet_args_list + k3s_kubelet_args -%}
{%- endif -%}

{#- Performance optimizations -#}
{%- if k3s_max_pods is defined and k3s_max_pods -%}
{%-   set _ = kubelet_args_list.append('max-pods=' + k3s_max_pods | string) -%}
{%- endif -%}

{%- if k3s_pods_per_core is defined and k3s_pods_per_core -%}
{%-   set _ = kubelet_args_list.append('pods-per-core=' + k3s_pods_per_core | string) -%}
{%- endif -%}

{#- High-performance image pulling -#}
{%- if k3s_serialize_image_pulls is defined and not k3s_serialize_image_pulls -%}
{%-   set _ = kubelet_args_list.append('serialize-image-pulls=false') -%}
{%- endif -%}

{#- Logging level for kubelet -#}
{%- if k3s_log_level is defined and k3s_log_level -%}
{%-   set _ = kubelet_args_list.append('log-level=' + k3s_log_level) -%}
{%- endif -%}

{#- Resource management optimizations -#}
{%- if k3s_kubelet_cpu_manager_policy is defined and k3s_kubelet_cpu_manager_policy -%}
{%-   set _ = kubelet_args_list.append('cpu-manager-policy=' + k3s_kubelet_cpu_manager_policy) -%}
{%- endif -%}

{%- if k3s_kubelet_topology_manager_policy is defined and k3s_kubelet_topology_manager_policy -%}
{%-   set _ = kubelet_args_list.append('topology-manager-policy=' + k3s_kubelet_topology_manager_policy) -%}
{%- endif -%}

{%- if k3s_kubelet_memory_manager_policy is defined and k3s_kubelet_memory_manager_policy -%}
{%-   set _ = kubelet_args_list.append('memory-manager-policy=' + k3s_kubelet_memory_manager_policy) -%}
{%- endif -%}

{#- Container log management -#}
{%- if k3s_container_log_max_size is defined and k3s_container_log_max_size -%}
{%-   set _ = kubelet_args_list.append('container-log-max-size=' + k3s_container_log_max_size) -%}
{%- endif -%}

{%- if k3s_container_log_max_files is defined and k3s_container_log_max_files -%}
{%-   set _ = kubelet_args_list.append('container-log-max-files=' + k3s_container_log_max_files | string) -%}
{%- endif -%}

{#- Node resource reservations -#}
{%- if k3s_kube_reserved is defined and k3s_kube_reserved -%}
{%-   for key, value in k3s_kube_reserved.items() -%}
{%-     set _ = kubelet_args_list.append('kube-reserved=' + key + '=' + value) -%}
{%-   endfor -%}
{%- endif -%}

{%- if k3s_system_reserved is defined and k3s_system_reserved -%}
{%-   for key, value in k3s_system_reserved.items() -%}
{%-     set _ = kubelet_args_list.append('system-reserved=' + key + '=' + value) -%}
{%-   endfor -%}
{%- endif -%}

{#- Eviction thresholds -#}
{%- if k3s_eviction_hard is defined and k3s_eviction_hard -%}
{%-   for threshold in k3s_eviction_hard -%}
{%-     set _ = kubelet_args_list.append('eviction-hard=' + threshold) -%}
{%-   endfor -%}
{%- endif -%}

{%- if k3s_eviction_soft is defined and k3s_eviction_soft -%}
{%-   for threshold in k3s_eviction_soft -%}
{%-     set _ = kubelet_args_list.append('eviction-soft=' + threshold) -%}
{%-   endfor -%}
{%- endif -%}

{%- if kubelet_args_list | length > 0 -%}
{%-   set _ = k3s_agent_config.update({'kubelet-arg': kubelet_args_list}) -%}
{%- endif -%}

{#- === KUBE-PROXY CONFIGURATION === -#}
{%- set kube_proxy_args_list = [] -%}
{%- if k3s_kube_proxy_args is defined and k3s_kube_proxy_args | length > 0 -%}
{%-   set kube_proxy_args_list = kube_proxy_args_list + k3s_kube_proxy_args -%}
{%- endif -%}

{#- Proxy mode optimization -#}
{%- if k3s_kube_proxy_mode is defined and k3s_kube_proxy_mode -%}
{%-   set _ = kube_proxy_args_list.append('proxy-mode=' + k3s_kube_proxy_mode) -%}
{%- endif -%}

{#- Metrics binding for monitoring -#}
{%- if k3s_kube_proxy_metrics_bind_address is defined and k3s_kube_proxy_metrics_bind_address -%}
{%-   set _ = kube_proxy_args_list.append('metrics-bind-address=' + k3s_kube_proxy_metrics_bind_address) -%}
{%- endif -%}

{#- Cluster CIDR for proxy -#}
{%- if k3s_kube_proxy_cluster_cidr is defined and k3s_kube_proxy_cluster_cidr -%}
{%-   set _ = kube_proxy_args_list.append('cluster-cidr=' + k3s_kube_proxy_cluster_cidr) -%}
{%- endif -%}

{%- if kube_proxy_args_list | length > 0 -%}
{%-   set _ = k3s_agent_config.update({'kube-proxy-arg': kube_proxy_args_list}) -%}
{%- endif -%}

{#- === EXPERIMENTAL & ADVANCED OPTIONS === -#}
{%- if k3s_rootless is defined and k3s_rootless -%}
{%-   set _ = k3s_agent_config.update({'rootless': true}) -%}
{%- endif -%}

{%- if k3s_enable_pprof is defined and k3s_enable_pprof -%}
{%-   set _ = k3s_agent_config.update({'enable-pprof': true}) -%}
{%- endif -%}

{%- if k3s_prefer_bundled_bin is defined and k3s_prefer_bundled_bin -%}
{%-   set _ = k3s_agent_config.update({'prefer-bundled-bin': true}) -%}
{%- endif -%}

# K3s Agent Configuration
# Generated by arillso.container.k3s role
#
# Enhanced with complete K3s agent feature set:
# - Comprehensive container runtime configuration
# - Advanced networking options (DNS, Flannel, VPN)
# - Performance optimization settings
# - Security and compliance features
# - Monitoring and debugging capabilities
# - Resource management and eviction policies
# - Image credential provider support
# - Experimental features for edge cases
#
# Agent Role: Worker node in K3s cluster
# Configuration hierarchy: CLI flags > Environment vars > This file
#
# Coverage: 42/44 available options (~95%)
{{ k3s_agent_config | to_nice_yaml(indent=2) }}
