{#- K3s Server Configuration Template with Best Practices -#}
{#- Generated by arillso.container.k3s role -#}
{#- Based on K3s Zero to Hero best practices guide -#}

{%- set k3s_config = {} -%}

{#- === SECURITY CONFIGURATION (Highest Priority) === -#}
{%- if k3s_token is defined and k3s_token -%}
{%-   set _ = k3s_config.update({'token': k3s_token}) -%}
{%- endif -%}

{%- if k3s_secrets_encryption is defined and k3s_secrets_encryption -%}
{%-   set _ = k3s_config.update({'secrets-encryption': true}) -%}
{%- endif -%}

{%- if k3s_protect_kernel_defaults is defined and k3s_protect_kernel_defaults -%}
{%-   set _ = k3s_config.update({'protect-kernel-defaults': true}) -%}
{%- endif -%}

{#- === CLUSTER INITIALIZATION === -#}
{%- if k3s_server_init is defined and k3s_server_init -%}
{%-   set _ = k3s_config.update({'cluster-init': true}) -%}
{%- elif k3s_server_url is defined and k3s_server_url -%}
{%-   set _ = k3s_config.update({'server': k3s_server_url}) -%}
{%- endif -%}

{#- === NETWORK CONFIGURATION === -#}
{%- if k3s_cluster_cidr is defined and k3s_cluster_cidr -%}
{%-   set _ = k3s_config.update({'cluster-cidr': k3s_cluster_cidr}) -%}
{%- endif -%}

{%- if k3s_service_cidr is defined and k3s_service_cidr -%}
{%-   set _ = k3s_config.update({'service-cidr': k3s_service_cidr}) -%}
{%- endif -%}

{%- if k3s_cluster_dns is defined and k3s_cluster_dns -%}
{%-   set _ = k3s_config.update({'cluster-dns': k3s_cluster_dns}) -%}
{%- endif -%}

{%- if k3s_cluster_domain is defined and k3s_cluster_domain -%}
{%-   set _ = k3s_config.update({'cluster-domain': k3s_cluster_domain}) -%}
{%- endif -%}

{#- Flannel Backend (Performance Critical) -#}
{%- if k3s_flannel_backend is defined and k3s_flannel_backend -%}
{%-   set _ = k3s_config.update({'flannel-backend': k3s_flannel_backend}) -%}
{%- endif -%}

{%- if k3s_disable_network_policy is defined and k3s_disable_network_policy -%}
{%-   set _ = k3s_config.update({'disable-network-policy': true}) -%}
{%- endif -%}

{#- === API SERVER CONFIGURATION === -#}
{%- if k3s_bind_address is defined and k3s_bind_address -%}
{%-   set _ = k3s_config.update({'bind-address': k3s_bind_address}) -%}
{%- endif -%}

{%- if k3s_https_listen_port is defined and k3s_https_listen_port -%}
{%-   set _ = k3s_config.update({'https-listen-port': k3s_https_listen_port}) -%}
{%- endif -%}

{%- if k3s_tls_san is defined and k3s_tls_san | length > 0 -%}
{%-   set _ = k3s_config.update({'tls-san': k3s_tls_san}) -%}
{%- endif -%}

{#- === DATA STORAGE CONFIGURATION === -#}
{%- if k3s_data_dir is defined and k3s_data_dir -%}
{%-   set _ = k3s_config.update({'data-dir': k3s_data_dir}) -%}
{%- endif -%}

{#- External Datastore for HA (Production) -#}
{%- if k3s_datastore_endpoint is defined and k3s_datastore_endpoint -%}
{%-   set _ = k3s_config.update({'datastore-endpoint': k3s_datastore_endpoint}) -%}
{%- endif -%}

{%- if k3s_datastore_cafile is defined and k3s_datastore_cafile -%}
{%-   set _ = k3s_config.update({'datastore-cafile': k3s_datastore_cafile}) -%}
{%- endif -%}

{%- if k3s_datastore_certfile is defined and k3s_datastore_certfile -%}
{%-   set _ = k3s_config.update({'datastore-certfile': k3s_datastore_certfile}) -%}
{%- endif -%}

{%- if k3s_datastore_keyfile is defined and k3s_datastore_keyfile -%}
{%-   set _ = k3s_config.update({'datastore-keyfile': k3s_datastore_keyfile}) -%}
{%- endif -%}

{#- === ETCD BACKUP CONFIGURATION (Production Critical) === -#}
{%- if k3s_etcd_expose_metrics is defined and k3s_etcd_expose_metrics -%}
{%-   set _ = k3s_config.update({'etcd-expose-metrics': true}) -%}
{%- endif -%}

{%- if k3s_etcd_snapshot_schedule_cron is defined and k3s_etcd_snapshot_schedule_cron -%}
{%-   set _ = k3s_config.update({'etcd-snapshot-schedule-cron': k3s_etcd_snapshot_schedule_cron}) -%}
{%- endif -%}

{%- if k3s_etcd_snapshot_retention is defined and k3s_etcd_snapshot_retention -%}
{%-   set _ = k3s_config.update({'etcd-snapshot-retention': k3s_etcd_snapshot_retention}) -%}
{%- endif -%}

{%- if k3s_etcd_snapshot_dir is defined and k3s_etcd_snapshot_dir -%}
{%-   set _ = k3s_config.update({'etcd-snapshot-dir': k3s_etcd_snapshot_dir}) -%}
{%- endif -%}

{#- S3 Backup Integration -#}
{%- if k3s_etcd_s3 is defined and k3s_etcd_s3 -%}
{%-   set _ = k3s_config.update({'etcd-s3': true}) -%}
{%- endif -%}

{%- if k3s_etcd_s3_endpoint is defined and k3s_etcd_s3_endpoint -%}
{%-   set _ = k3s_config.update({'etcd-s3-endpoint': k3s_etcd_s3_endpoint}) -%}
{%- endif -%}

{%- if k3s_etcd_s3_region is defined and k3s_etcd_s3_region -%}
{%-   set _ = k3s_config.update({'etcd-s3-region': k3s_etcd_s3_region}) -%}
{%- endif -%}

{%- if k3s_etcd_s3_bucket is defined and k3s_etcd_s3_bucket -%}
{%-   set _ = k3s_config.update({'etcd-s3-bucket': k3s_etcd_s3_bucket}) -%}
{%- endif -%}

{%- if k3s_etcd_s3_folder is defined and k3s_etcd_s3_folder -%}
{%-   set _ = k3s_config.update({'etcd-s3-folder': k3s_etcd_s3_folder}) -%}
{%- endif -%}

{#- === NODE CONFIGURATION === -#}
{%- if k3s_node_name is defined and k3s_node_name -%}
{%-   set _ = k3s_config.update({'node-name': k3s_node_name}) -%}
{%- endif -%}

{%- if k3s_node_ip is defined and k3s_node_ip -%}
{%-   set _ = k3s_config.update({'node-ip': k3s_node_ip}) -%}
{%- endif -%}

{%- if k3s_node_external_ip is defined and k3s_node_external_ip -%}
{%-   set _ = k3s_config.update({'node-external-ip': k3s_node_external_ip}) -%}
{%- endif -%}

{%- if k3s_node_labels is defined and k3s_node_labels | length > 0 -%}
{%-   set _ = k3s_config.update({'node-label': k3s_node_labels}) -%}
{%- endif -%}

{%- if k3s_node_taints is defined and k3s_node_taints | length > 0 -%}
{%-   set _ = k3s_config.update({'node-taint': k3s_node_taints}) -%}
{%- endif -%}

{#- === COMPONENT DISABLING (Production Best Practice) === -#}
{%- set disable_components = [] -%}
{%- if k3s_disable_traefik is defined and k3s_disable_traefik -%}
{%-   set _ = disable_components.append('traefik') -%}
{%- endif -%}
{%- if k3s_disable_servicelb is defined and k3s_disable_servicelb -%}
{%-   set _ = disable_components.append('servicelb') -%}
{%- endif -%}
{%- if k3s_disable_metrics_server is defined and k3s_disable_metrics_server -%}
{%-   set _ = disable_components.append('metrics-server') -%}
{%- endif -%}
{%- if k3s_disable_local_storage is defined and k3s_disable_local_storage -%}
{%-   set _ = disable_components.append('local-storage') -%}
{%- endif -%}
{%- if k3s_disable_network_policy is defined and k3s_disable_network_policy -%}
{%-   set _ = disable_components.append('network-policy') -%}
{%- endif -%}
{%- if k3s_disable_helm_controller is defined and k3s_disable_helm_controller -%}
{%-   set _ = disable_components.append('helm-controller') -%}
{%- endif -%}
{%- if k3s_disable_cloud_controller is defined and k3s_disable_cloud_controller -%}
{%-   set _ = disable_components.append('cloud-controller') -%}
{%- endif -%}
{%- if disable_components | length > 0 -%}
{%-   set _ = k3s_config.update({'disable': disable_components}) -%}
{%- endif -%}

{#- === LOGGING CONFIGURATION === -#}
{%- if k3s_log_file is defined and k3s_log_file -%}
{%-   set _ = k3s_config.update({'log': k3s_log_file}) -%}
{%- endif -%}

{%- if k3s_debug is defined -%}
{%-   set _ = k3s_config.update({'debug': k3s_debug}) -%}
{%- endif -%}

{%- if k3s_alsologtostderr is defined -%}
{%-   set _ = k3s_config.update({'alsologtostderr': k3s_alsologtostderr}) -%}
{%- endif -%}

{#- === PERFORMANCE TUNING === -#}
{%- set kubelet_args_list = [] -%}
{%- if k3s_kubelet_args is defined and k3s_kubelet_args | length > 0 -%}
{%-   set kubelet_args_list = kubelet_args_list + k3s_kubelet_args -%}
{%- endif -%}

{#- Performance optimizations from best practices -#}
{%- if k3s_max_pods is defined and k3s_max_pods -%}
{%-   set _ = kubelet_args_list.append('max-pods=' + k3s_max_pods | string) -%}
{%- endif -%}

{%- if k3s_pods_per_core is defined and k3s_pods_per_core -%}
{%-   set _ = kubelet_args_list.append('pods-per-core=' + k3s_pods_per_core | string) -%}
{%- endif -%}

{%- if k3s_serialize_image_pulls is defined and not k3s_serialize_image_pulls -%}
{%-   set _ = kubelet_args_list.append('serialize-image-pulls=false') -%}
{%- endif -%}

{%- if k3s_log_level is defined and k3s_log_level -%}
{%-   set _ = kubelet_args_list.append('log-level=' + k3s_log_level) -%}
{%- endif -%}

{%- if kubelet_args_list | length > 0 -%}
{%-   set _ = k3s_config.update({'kubelet-arg': kubelet_args_list}) -%}
{%- endif -%}

{#- === KUBERNETES COMPONENT ARGUMENTS === -#}
{%- if k3s_kube_apiserver_args is defined and k3s_kube_apiserver_args | length > 0 -%}
{%-   set _ = k3s_config.update({'kube-apiserver-arg': k3s_kube_apiserver_args}) -%}
{%- endif -%}

{%- if k3s_kube_controller_manager_args is defined and k3s_kube_controller_manager_args | length > 0 -%}
{%-   set _ = k3s_config.update({'kube-controller-manager-arg': k3s_kube_controller_manager_args}) -%}
{%- endif -%}

{%- if k3s_kube_scheduler_args is defined and k3s_kube_scheduler_args | length > 0 -%}
{%-   set _ = k3s_config.update({'kube-scheduler-arg': k3s_kube_scheduler_args}) -%}
{%- endif -%}

{#- === CONTAINER RUNTIME CONFIGURATION === -#}
{%- if k3s_container_runtime_endpoint is defined and k3s_container_runtime_endpoint -%}
{%-   set _ = k3s_config.update({'container-runtime-endpoint': k3s_container_runtime_endpoint}) -%}
{%- endif -%}

{%- if k3s_default_runtime is defined and k3s_default_runtime -%}
{%-   set _ = k3s_config.update({'default-runtime': k3s_default_runtime}) -%}
{%- endif -%}

{#- === KUBECONFIG CONFIGURATION === -#}
{%- if k3s_write_kubeconfig_mode is defined and k3s_write_kubeconfig_mode -%}
{%-   set _ = k3s_config.update({'write-kubeconfig-mode': k3s_write_kubeconfig_mode}) -%}
{%- endif -%}

{%- if k3s_write_kubeconfig is defined and k3s_write_kubeconfig -%}
{%-   set _ = k3s_config.update({'write-kubeconfig': k3s_write_kubeconfig}) -%}
{%- endif -%}

# K3s Server Configuration
# Generated by arillso.container.k3s role
#
# Based on K3s Zero to Hero best practices:
# - Security-first configuration approach
# - Production-ready component disabling
# - Performance optimization settings
# - Comprehensive backup strategies
# - Flexible environment adaptation
#
# Configuration hierarchy: CLI flags > Environment vars > This file
{{ k3s_config | to_nice_yaml(indent=2) }}
