{{ '#!/bin/bash' }}
# K3s Killall Script - Based on official K3s killall script
# Generated by arillso.container.k3s role

set -e

# Check if running as root
if [ $(id -u) -ne 0 ]; then
    exec sudo --preserve-env=K3S_DATA_DIR $0 $@
fi

K3S_DATA_DIR=${K3S_DATA_DIR:-{{ k3s_data_dir }}}

# Add K3s binary paths to PATH
for bin in ${K3S_DATA_DIR}/data/**/bin/; do
    [ -d $bin ] && export PATH=$PATH:$bin:$bin/aux
done

set -x

# Stop all K3s systemd services
for service in /etc/systemd/system/k3s*.service; do
    [ -s $service ] && systemctl stop $(basename $service)
done

# Stop all K3s init.d services (OpenRC)
for service in /etc/init.d/k3s*; do
    [ -x $service ] && $service stop
done

# Function to get child processes
pschildren() {
    ps -e -o ppid= -o pid= | \
    sed -e 's/^\s*//g; s/\s\s*/\t/g;' | \
    grep -w "^$1" | \
    cut -f2
}

# Function to get process tree
pstree() {
    for pid in $@; do
        echo $pid
        for child in $(pschildren $pid); do
            pstree $child
        done
    done
}

# Function to kill process tree
killtree() {
    kill -9 $(
        { set +x; } 2>/dev/null;
        pstree $@;
        set -x;
    ) 2>/dev/null
}

# Function to remove network interfaces
remove_interfaces() {
    # Delete network interface(s) that match 'master cni0'
    ip link show 2>/dev/null | grep 'master cni0' | while read ignore iface ignore; do
        iface=${iface%%@*}
        [ -z "$iface" ] || ip link delete $iface
    done

    # Delete CNI related interfaces
    ip link delete cni0 2>/dev/null || true
    ip link delete flannel.1 2>/dev/null || true
    ip link delete flannel-v6.1 2>/dev/null || true
    ip link delete kube-ipvs0 2>/dev/null || true
    ip link delete flannel-wg 2>/dev/null || true
    ip link delete flannel-wg-v6 2>/dev/null || true

    # Restart tailscale if available
    if [ -n "$(command -v tailscale)" ]; then
        tailscale set --advertise-routes= 2>/dev/null || true
    fi
}

# Function to get containerd shims
getshims() {
    ps -e -o pid= -o args= | sed -e 's/^ *//; s/\s\s*/\t/;' | grep -w "${K3S_DATA_DIR}"'/data/[^/]*/bin/containerd-shim' | cut -f1
}

# Kill containerd shims
killtree $({ set +x; } 2>/dev/null; getshims; set -x)

# Function to unmount and remove directories
do_unmount_and_remove() {
    set +x
    while read -r _ path _; do
        case "$path" in $1*) echo "$path" ;; esac
    done < /proc/self/mounts | sort -r | xargs -r -t -n 1 sh -c 'umount -f "$0" && rm -rf "$0"'
    set -x
}

# Unmount and remove K3s directories
do_unmount_and_remove '/run/k3s'
do_unmount_and_remove '/var/lib/kubelet/pods'
do_unmount_and_remove '/var/lib/kubelet/plugins'
do_unmount_and_remove '/run/netns/cni-'

# Remove CNI namespaces
ip netns show 2>/dev/null | grep cni- | xargs -r -t -n 1 ip netns delete

# Remove network interfaces
remove_interfaces

# Remove CNI directories
rm -rf /var/lib/cni/ 2>/dev/null || true

# Clean up iptables rules
iptables-save 2>/dev/null | grep -v KUBE- | grep -v CNI- | grep -iv flannel | iptables-restore 2>/dev/null || true
ip6tables-save 2>/dev/null | grep -v KUBE- | grep -v CNI- | grep -iv flannel | ip6tables-restore 2>/dev/null || true

echo "K3s processes and resources have been cleaned up"
