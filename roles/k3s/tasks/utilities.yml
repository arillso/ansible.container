---
# K3s Utilities and Symlinks Configuration
# Post-installation tasks for K3s utility commands and helper scripts
# Requires K3s binary to be installed and available at /usr/local/bin/k3s

- name: Verify K3s binary is installed
  ansible.builtin.stat:
      path: /usr/local/bin/k3s
  register: k3s_binary_check

- name: Fail if K3s binary is not found
  ansible.builtin.fail:
      msg: "K3s binary not found at /usr/local/bin/k3s. This task file should only run after K3s installation."
  when: not k3s_binary_check.stat.exists

- name: Create K3s utility symlinks
  ansible.builtin.file:
      src: /usr/local/bin/k3s
      dest: "/usr/local/bin/{{ item }}"
      state: link
      owner: root
      group: root
  loop: "{{ k3s_symlink_commands }}"
  become: true
  when:
      - k3s_create_symlinks | bool

# - name: Create K3s environment configuration file
#   ansible.builtin.template:
#       src: etc/systemd/system/k3s.service.env.j2
#       dest: /etc/systemd/system/k3s.service.env
#       mode: "0600"
#       owner: root
#       group: root
#   become: true
#   notify: restart k3s
#   when: k3s_environment_vars | length > 0

- name: Create bash completion directory
  ansible.builtin.file:
      path: /etc/bash_completion.d
      state: directory
      mode: "0755"
      owner: root
      group: root
  become: true
  when:
      - k3s_create_bash_completion | default(true) | bool
      - ansible_os_family in ['Debian', 'RedHat']

- name: Create K3s bash completion
  ansible.builtin.shell: |
      /usr/local/bin/k3s completion bash > /etc/bash_completion.d/k3s
  become: true
  when:
      - k3s_create_bash_completion | default(true) | bool
      - ansible_os_family in ['Debian', 'RedHat']
      - k3s_completion_test is defined
      - k3s_completion_test.rc == 0
  changed_when: true

- name: Create kubectl bash completion (if kubectl symlink exists)
  ansible.builtin.shell: |
      /usr/local/bin/kubectl completion bash > /etc/bash_completion.d/kubectl
  become: true
  when:
      - k3s_create_bash_completion | default(true) | bool
      - k3s_create_symlinks | bool
      - "'kubectl' in k3s_symlink_commands"
      - ansible_os_family in ['Debian', 'RedHat']
      - k3s_completion_test is defined
      - k3s_completion_test.rc == 0
  changed_when: true
