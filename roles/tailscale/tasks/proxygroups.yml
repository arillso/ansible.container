---
# Tailscale ProxyGroups management tasks
# Supports: ingress, egress, kube-apiserver

- name: Create namespaces for Tailscale ProxyGroups
  kubernetes.core.k8s:
      kubeconfig: "{{ tailscale_kubeconfig_path }}"
      name: "{{ item.namespace }}"
      api_version: v1
      kind: Namespace
      state: "{{ tailscale_state }}"
  loop: "{{ tailscale_proxygroups }}"
  when:
      - tailscale_state == "present"
      - item.namespace is defined
  tags:
      - tailscale
      - tailscale-proxygroups
      - tailscale-namespace

- name: Manage Tailscale ProxyGroups
  kubernetes.core.k8s:
      kubeconfig: "{{ tailscale_kubeconfig_path }}"
      state: "{{ tailscale_state }}"
      definition:
          apiVersion: tailscale.com/v1alpha1
          kind: ProxyGroup
          metadata:
              name: "{{ item.name }}"
              namespace: "{{ item.namespace | default('default') }}"
          spec:
              type: "{{ item.type }}"
              replicas: "{{ item.replicas | default(1) }}"
              tags: "{{ item.tags }}"
              hostnamePrefix: "{{ item.hostname_prefix | default(omit) }}"
              kubeAPIServer: "{{ item.kube_apiserver | default(omit) }}"
  loop: "{{ tailscale_proxygroups }}"
  tags:
      - tailscale
      - tailscale-proxygroups
