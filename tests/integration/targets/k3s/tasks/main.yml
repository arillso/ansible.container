---
# Integration tests for k3s role

- name: Include k3s role as server
  ansible.builtin.include_role:
      name: arillso.container.k3s
  vars:
      k3s_role: server
      k3s_cluster_init: true

- name: Wait for k3s to be ready
  ansible.builtin.wait_for:
      path: /etc/rancher/k3s/k3s.yaml
      state: present
      timeout: 300

- name: Verify k3s is installed
  ansible.builtin.command: k3s --version
  register: k3s_version
  changed_when: false

- name: Display k3s version
  ansible.builtin.debug:
      var: k3s_version.stdout

- name: Check k3s service is running
  ansible.builtin.service:
      name: k3s
      state: started
  check_mode: true
  register: k3s_service
  failed_when: k3s_service.changed

- name: Verify kubectl is available
  ansible.builtin.command: kubectl version --client
  register: kubectl_version
  changed_when: false
  environment:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Check cluster nodes
  ansible.builtin.command: kubectl get nodes
  register: k3s_nodes
  changed_when: false
  environment:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Display cluster nodes
  ansible.builtin.debug:
      var: k3s_nodes.stdout_lines

- name: Verify node is Ready
  ansible.builtin.shell: kubectl get nodes -o jsonpath='{.items[0].status.conditions[?(@.type=="Ready")].status}'
  register: node_status
  changed_when: false
  environment:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Assert node is Ready
  ansible.builtin.assert:
      that:
          - "'True' in node_status.stdout"
      fail_msg: "K3s node is not in Ready state"
      success_msg: "K3s node is Ready"

- name: Test pod deployment
  kubernetes.core.k8s:
      kubeconfig: /etc/rancher/k3s/k3s.yaml
      state: present
      definition:
          apiVersion: v1
          kind: Pod
          metadata:
              name: test-nginx
              namespace: default
          spec:
              containers:
                  - name: nginx
                    image: nginx:alpine
                    ports:
                        - containerPort: 80

- name: Wait for test pod to be running
  kubernetes.core.k8s_info:
      kubeconfig: /etc/rancher/k3s/k3s.yaml
      kind: Pod
      name: test-nginx
      namespace: default
  register: test_pod
  until: test_pod.resources[0].status.phase == "Running"
  retries: 30
  delay: 10

- name: Verify pod is running
  ansible.builtin.assert:
      that:
          - test_pod.resources | length > 0
          - test_pod.resources[0].status.phase == "Running"
      fail_msg: "Test pod failed to start"
      success_msg: "Test pod is running successfully"

- name: Cleanup test pod
  kubernetes.core.k8s:
      kubeconfig: /etc/rancher/k3s/k3s.yaml
      state: absent
      kind: Pod
      name: test-nginx
      namespace: default

- name: Check k3s facts
  ansible.builtin.debug:
      var: ansible_local.k3s
  when: ansible_local.k3s is defined

- name: Verify k3s configuration directory exists
  ansible.builtin.stat:
      path: /etc/rancher/k3s
  register: k3s_config_dir

- name: Assert k3s configuration directory exists
  ansible.builtin.assert:
      that:
          - k3s_config_dir.stat.exists
          - k3s_config_dir.stat.isdir
      fail_msg: "K3s configuration directory not found"
      success_msg: "K3s configuration directory exists"
